# Шаги загрузки операционной системы

## Общая цепочка
1) **Питание и прошивка**: нажатие кнопки/сигнал по сети запускает блок питания, формируются стабильные линии напряжений, сигнал `PWR_OK` снимает аппаратный reset; CPU берет адрес сброса из прошивки, выполняет встроенный микрокод, чипсет инициализирует контроллеры (память, PCIe, SATA, USB), запускается POST, прошивка настраивает таблицы конфигурации (ACPI/SMBIOS) и выбирает устройство, с которого читать первый блок кода.
2) **Загрузчик 1‑й ступени**: минимальный код из MBR или EFI System Partition, который умеет только считать с диска несколько секторов/файл второй ступени; в BIOS это 512 байт MBR плюс дополнительный «core image» на диске, в UEFI — небольшой `*.efi`‑файл, зарегистрированный как загрузочная запись в NVRAM.
3) **Загрузчик 2‑й ступени**: полноценный загрузчик (GRUB, systemd-boot, rEFInd, LILO) с поддержкой файловых систем; читает конфигурацию, показывает меню, дает выбрать ядро и опции, при необходимости подгружает модули для RAID/LVM/шифрования, копирует образ ядра и initramfs в память и формирует строку параметров командной строки ядра.
4) **Переход в ядро**: загрузчик переключает процессор из реального режима в защищенный/long mode, строит минимальные таблицы страниц (обычно identity‑mapping для низкой памяти), заполняет структуру параметров загрузки (boot params), выставляет регистры (в т.ч. указатель на параметры) и безвозвратно передает управление в точку входа ядра.
5) **Инициализация ядра**: ранний аллокатор и разбор карты памяти (e820/UEFI memory map), парсинг ACPI и других таблиц прошивки, включение базовых драйверов (консоль раннего вывода, таймеры, прерывания), запуск полноценного менеджера виртуальной памяти и KASLR, инициализация блочного слоя и поиск root‑файловой системы (через initramfs при необходимости), старт процесса `init`/`systemd` с PID 1.
6) **Пользовательское пространство (init/systemd)**: монтирование псевдо‑файловых систем (`/proc`, `/sys`, `/dev`, `/run`), подготовка и перемонтирование корневой FS (mount/chroot/remount rw), запуск юнитов/скриптов (сеть, логи, getty, дисплейный менеджер, демоны), переход к целевому runlevel/target (multi‑user, graphical) и запуск пользовательских приложений.

## UEFI vs BIOS
- BIOS: реальный режим, MBR, ограничение на 2 TB диски без GPT; загрузчик сам переходит в защищенный режим.
- UEFI: исполняемые EFI, драйверы в прошивке, поддержка GPT, переменные NVRAM, протоколы GOP для графики; загрузчик проще (systemd-boot, GRUB EFI).

## Initramfs
- Минимальная root‑файловая система в памяти (cpio‑архив, разворачиваемый в tmpfs), которую ядро монтирует первой и из которой стартует процесс `/init`.
- Содержит только то, что нужно, чтобы найти и смонтировать «настоящий» корень: драйверы контроллеров хранения, модули файловых систем, скрипты/бинарники сборки RAID/LVM и расшифровки корневого раздела.
- Разрывает жёсткую привязку ядра к конкретному железу: само ядро может быть универсальным, а специфичные драйверы/логика зависят от содержимого initramfs (dracut, initramfs‑tools и т.п.)
- После нахождения и монтирования реального root FS выполняется `pivot_root`/`switch_root`, дальше PID 1 уже работает из постоянной файловой системы.
- На простых конфигурациях (один SATA/SSD‑диск без шифрования и LVM) initramfs может быть сведён к минимуму или вообще не использоваться, если драйверы собраны в само ядро.

## Подробности передачи управления (x86_64/Linux)
- Загрузчик размещает `vmlinuz` и `initramfs` в RAM, заполняет структуру boot params, устанавливает регистры (RDI указывает на параметры).
- Ядро включает страничную адресацию, настраивает GDT/IDT, детектирует CPU, запускает вторичные ядра (SMP bring-up) через APIC/firmware tables.
- После инициализации subsystems (scheduler, VFS, сетевой стек) ядро вызывает `kernel_init`, который через `execve` запускает PID 1.

## Термины и аббревиатуры
- `PWR_OK` — сигнал блока питания, которым он сообщает плате, что все линии напряжений в норме и можно снимать reset.
- POST — Power‑On Self Test: минимальный тест памяти и базовых устройств, который выполняет прошивка сразу после снятия reset.
- Firmware — код в постоянной памяти платы (чип SPI‑Flash), который инициализирует железо до загрузки ОС.
- BIOS — Basic Input/Output System: классическая прошивка IBM‑совместимых ПК, работает в реальном режиме и стартует код из MBR.
- UEFI — Unified Extensible Firmware Interface: современная прошивка с собственным драйверным стеком и загрузкой `*.efi`‑программ из EFI System Partition.
- EFI — Extensible Firmware Interface: предшественник UEFI; сегодня термин обычно используют для обозначения формата исполняемых файлов `*.efi`.
- ACPI — Advanced Configuration and Power Interface: набор таблиц, описывающих устройства, IRQ, энергосостояния и прочую платформенную конфигурацию для ОС.
- SMBIOS — System Management BIOS: таблицы с информацией о системе (модель, серийники, слоты памяти и т.п.), которые читает ОС и утилиты инвентаризации.
- PCIe — Peripheral Component Interconnect Express: основной высокоскоростной шинный интерфейс для подключения видеокарт, NVMe‑накопителей и других устройств.
- SATA — Serial ATA: последовательный интерфейс для подключения жёстких дисков и SSD.
- USB — Universal Serial Bus: универсальная шина для периферийных устройств (клавиатуры, мыши, флешки и т.д.).
- SSD — Solid State Drive: твердотельный накопитель без механики, обычно быстрее классических HDD.
- MBR — Master Boot Record: первый сектор диска (512 байт) с кодом загрузчика первой ступени и старой схемой разметки разделов.
- EFI System Partition (ESP) — специальный раздел на диске с файловой системой FAT, откуда UEFI загружает `*.efi`‑файлы (загрузчики, утилиты).
- NVRAM — Non‑Volatile RAM: энергонезависимая память в прошивке, где UEFI хранит список загрузочных записей и переменные среды.
- GRUB — GRand Unified Bootloader: сложный загрузчик Linux/Unix‑систем с поддержкой множества ФС, скриптов и модулей.
- systemd‑boot — минималистичный UEFI‑загрузчик из проекта systemd, читающий конфигурацию из простых текстовых файлов.
- rEFInd — UEFI‑загрузчик с графическим меню, умеющий автоматически находить ядра ОС.
- LILO — LInux LOader: старый BIOS‑загрузчик Linux, практически вытеснен GRUB, но всё ещё встречается в исторических системах.
- Initramfs — Initial RAM Filesystem: начальная файловая система в RAM, с которой стартует ядро, пока не найден и не смонтирован постоянный root.
- cmdline (kernel command line) — строка параметров ядра, которую формирует загрузчик и передаёт ядру при старте.
- Long mode — 64‑битный режим работы x86_64‑процессора; предшествующие ему режимы — реальный и 32‑битный защищённый.
- e820 — исторический формат карты памяти BIOS/UEFI, описывает, какие диапазоны RAM доступны ОС.
- Memory map — карта памяти, которую прошивка передаёт ядру: какие диапазоны RAM, MMIO, зарезервированные области и т.п.
- APIC — Advanced Programmable Interrupt Controller: контроллер прерываний для многопроцессорных систем.
- IOAPIC — I/O Advanced Programmable Interrupt Controller: контроллер переназначения прерываний от устройств к нужным ядрам CPU.
- CPU — Central Processing Unit: центральный процессор, исполняющий инструкции ядра и пользователей.
- KASLR — Kernel Address Space Layout Randomization: рандомизация расположения ядра в виртуальной памяти для усложнения эксплуатации уязвимостей.
- Root FS — корневая файловая система (`/`), относительно которой видны все остальные пути в ОС.
- PID — Process ID: уникальный идентификатор процесса в ядре Linux; PID 1 — первый пользовательский процесс.
- Runlevel — традиционный уровень режима работы в SysV init (single‑user, multi‑user, графический и т.п.).
- target — абстракция systemd, аналогичная runlevel, но заданная набором зависимых юнитов (например, `multi-user.target`, `graphical.target`).
- GPT — GUID Partition Table: современная схема разметки диска с 64‑битными LBA и идентификаторами разделов GUID.
- GUID — Globally Unique Identifier: 128‑битный идентификатор сущности (раздела, тома, объекта и т.п.).
- LBA — Logical Block Addressing: способ адресации блоков на диске по номеру блока вместо CHS‑координат.
- NVRAM variable — переменная конфигурации UEFI, доступная ОС через драйверы UEFI/efivarfs.
- GOP — Graphics Output Protocol: стандартный интерфейс UEFI для работы с графическим видеовыводом.
- RAM — Random Access Memory: оперативная память, в которой живут ядро, initramfs и процессы.
- boot params — структура параметров, которую загрузчик заполняет и передаёт ядру (адреса initramfs, cmdline, флаги режима и т.п.).
- RDI — регистр общего назначения x86_64, который по ABI System V часто используется как первый аргумент функции; в Linux‑загрузке в него кладут указатель на boot params.
- GDT — Global Descriptor Table: таблица дескрипторов сегментов для защищённого режима x86.
- IDT — Interrupt Descriptor Table: таблица обработчиков прерываний, которую настраивает ядро.
- SMP — Symmetric MultiProcessing: режим, при котором несколько ядер CPU равноправно выполняют задачи под управлением одного ядра ОС.
- VFS — Virtual File System: абстрактный слой ядра, через который реализуются конкретные файловые системы (ext4, XFS, btrfs и т.д.).
- `execve` — системный вызов Linux, заменяющий образ текущего процесса новым (загрузка бинарника в адресное пространство).
- getty — программа, которая обслуживает TTY‑консоль (логин‑промпт) и порождает процессы `login`/`shell`.
- TTY — Teletype: историческое название текстового терминала; в Linux терминалы представлены как устройства `/dev/tty*`.
- RAID — Redundant Array of Independent Disks: схема объединения дисков для отказоустойчивости и/или скорости.
- LVM — Logical Volume Manager: слой абстракции над физическими дисками/разделами, позволяющий создавать логические тома.
- x86_64 — 64‑битная архитектура процессора x86 с расширением AMD64/Intel 64.
- TB — Terabyte: единица измерения ёмкости хранения данных (≈10¹² байт).
- GOP console — текстовый/графический вывод через Graphics Output Protocol в UEFI вместо классического VGA.
- VGA — Video Graphics Array: базовый графический режим, поддерживаемый почти всеми видеокартами и BIOS/UEFI.
- `dmesg` — утилита, выводящая ring‑buffer сообщений ядра.
- `systemd.unit` — параметр командной строки systemd, указывающий, какой target/юнит запустить первым (например, `rescue.target`).
- `GRUB_TERMINAL` — параметр конфигурации GRUB, задающий, какие терминалы использовать (VGA, serial и т.п.).
- `ttyS0` — первая последовательная (serial) консоль в Linux, часто используемая для удалённой отладки загрузки.

## Средства диагностики
- Журнал ядра: `dmesg`, `/var/log/kern.log`.
- Параметры командной строки: `quiet`, `debug`, `systemd.unit=rescue.target`, `init=/bin/sh`.
- Bootloader consoles: `GRUB_TERMINAL`, `serial console=ttyS0,115200`.

## Источники
- Таненбаум, Бос. «Современные операционные системы».
- Love. «Linux Kernel Development».
- UEFI Spec, BIOS INT 0x19/0x13 исторически.
