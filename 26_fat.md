# FAT

Файловая система **FAT** (File Allocation Table) использует таблицу размещения файлов (FAT), чтобы управлять расположением данных на диске. Это простая и эффективная структура для организации хранения данных. Давайте разберем основные моменты, связанные с этим механизмом и внутренними структурами.

### 1. **CHS (Cylinder, Head, Sector)**:

**CHS** — это метод адресации данных на жестком диске, который используется для указания местоположения данных.

- **Цилиндр (Cylinder)** — это вертикальный набор секторов на разных дисках.
- **Головка (Head)** — это физическая головка, которая читает или записывает данные на конкретной поверхности диска.
- **Сектор (Sector)** — это минимальная единица данных на диске, обычно размером 512 байт. Это маленькая область, в которой хранятся данные.

### 2. **Размер сектора и кластера**:

- **Сектор** — это минимальная единица хранения данных, обычно равная **512 байт**.
- **Кластер** — несколько секторов, которые объединены в одну единицу для более эффективного хранения данных. Размер кластера может варьироваться в зависимости от файловой системы, например, это может быть 4 КБ (например, 8 секторов по 512 байт).
- Когда данные файла занимают несколько кластеров, каждый кластер в таблице FAT получает указатель на следующий кластер в цепочке. Таким образом, файл, состоящий из нескольких кластеров, будет иметь серию связанных кластеров в таблице FAT.

### 3. **Slack space (пустое место)**:

- **Slack space** — это неиспользуемое пространство в последнем кластере файла, которое возникает из-за того, что файл не всегда точно заполняет весь кластер. Например, если файл имеет размер 5 КБ, а размер кластера — 4 КБ, то данные файла будут занимать 2 кластера (8 КБ), и оставшийся 3 КБ в последнем кластере будут пустыми. Это и называется **Slack**.
- В случае с FAT файловыми системами, это пустое пространство остается на диске, и оно не используется для других файлов, что приводит к внутренней фрагментации.

### 4. **Структура таблицы FAT**:

Таблица FAT представляет собой массив, где каждый элемент соответствует кластеру на диске. В зависимости от версии FAT, размер элемента в таблице может быть разным:

- **FAT12** — 12 бит для каждого кластера.
- **FAT16** — 16 бит.
- **FAT32** — 32 бита.

В таблице FAT каждый кластер может быть в одном из трех состояний:

1. **Свободный** — ячейка таблицы указывает на 0, что означает, что кластер свободен и может быть использован для записи данных.
2. **Занят** — ячейка таблицы указывает на номер следующего кластера в цепочке для данного файла. Если кластер — последний в цепочке, таблица будет содержать специальное значение (например, **0xFFFF** в FAT16 или **0x0FFFFFFF** в FAT32).
3. **Битый** — ячейка таблицы может содержать специальный код, который указывает на поврежденный или недоступный кластер (например, **0x0FFFFFF8** в FAT32), что предотвращает его использование.
### Пример работы с FAT:

Предположим, что у нас есть файл размером 6 КБ и размер кластера составляет 4 КБ. Это означает, что файл займет два кластера, но фактически будет использовать только 6 КБ из 8 КБ.

1. **Таблица FAT**:
    - Кластер 1: указывает на кластер 2 (данные файла продолжаются).
    - Кластер 2: указывает на **0xFFFF** (конец файла).
Связка с VFS выглядит так: запись каталога даёт первый кластер файла, драйвер FAT по цепочке в таблице читает данные, пока не встретит маркер конца файла. Остальная логика (доступ по именам, права) остаётся на стороне VFS.
