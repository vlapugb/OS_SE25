# Сеть в операционных системах: абстракции ядра, sk_buff, pbuf, NAPI

## 1. Сетевой стек в пространстве ядра

Сетевой стек операционной системы реализуется преимущественно в **пространстве ядра**, так как:
- требуется высокая производительность;
- необходим прямой доступ к аппаратным ресурсам;
- важно минимизировать задержки и копирование данных.

Ядро предоставляет абстракции, скрывающие детали конкретного сетевого оборудования и протоколов.

---

## 2. Основные сетевые абстракции ядра

### 2.1 Сетевой интерфейс (Network Interface)

Сетевой интерфейс представляет физическое или виртуальное сетевое устройство.

Функции:
- передача и приём пакетов;
- взаимодействие с драйвером устройства;
- регистрация в сетевом стеке.

Примеры:
- Ethernet-интерфейсы;
- loopback;
- виртуальные интерфейсы (veth, tun/tap).

---

### 2.2 Сетевой пакет

Сетевой пакет — основная единица передачи данных в сетевом стеке.

Характеристики:
- содержит заголовки разных уровней (L2–L4);
- может изменяться при прохождении по стеку;
- требует эффективного управления памятью.

Для представления пакетов в ядре используются специальные структуры данных:
- **sk_buff** (Linux);
- **pbuf** (lwIP).

---

### 2.3 Очереди и буферы

Для асинхронной обработки пакетов используются:
- очереди приёма;
- очереди передачи;
- буферы ожидания.

Очереди позволяют:
- сглаживать пиковые нагрузки;
- обеспечивать потоковую обработку;
- уменьшать потери пакетов.

---

## 3. sk_buff (Socket Buffer) — Linux

### 3.1 Назначение sk_buff

**sk_buff** — ключевая структура Linux для представления сетевого пакета в ядре.

Используется:
- драйверами сетевых карт;
- протоколами (IP, TCP, UDP);
- сокетами.

---

### 3.2 Структура sk_buff

sk_buff содержит:
- указатель на данные пакета;
- длину полезной нагрузки;
- указатели на заголовки (MAC, IP, TCP/UDP);
- метаданные маршрутизации;
- информацию о сокете-владельце;
- ссылки для включения в очереди.

Данные и заголовки могут сдвигаться без копирования памяти.

---

### 3.3 Жизненный цикл sk_buff

1. Выделение буфера драйвером или стеком.
2. Заполнение данными.
3. Прохождение по сетевому стеку.
4. Передача в сокет или на устройство.
5. Освобождение памяти.

---

### 3.4 Преимущества sk_buff

- Универсальность.
- Минимизация копирования данных.
- Поддержка zero-copy.
- Гибкость при работе с протоколами.

Недостаток — высокая сложность структуры.

---

## 4. pbuf — lwIP

### 4.1 Назначение pbuf

**pbuf** — структура для представления сетевых пакетов в стеке lwIP, широко используемом во встраиваемых системах.

Основная цель — минимальные накладные расходы.

---

### 4.2 Типы pbuf

lwIP использует цепочки pbuf:

- **PBUF_RAM** — данные в оперативной памяти;
- **PBUF_ROM** — данные в постоянной памяти;
- **PBUF_REF** — ссылка на внешний буфер;
- **PBUF_POOL** — буферы из пула.

pbuf могут быть связаны в цепочку без копирования данных.

---

### 4.3 Особенности pbuf

- Простая структура.
- Малый размер.
- Подходит для систем с ограниченными ресурсами.
- Меньшая гибкость по сравнению с sk_buff.

---

## 5. Сравнение sk_buff и pbuf

| Характеристика | sk_buff | pbuf |
|---------------|--------|------|
| ОС | Linux | lwIP |
| Сложность | Высокая | Низкая |
| Гибкость | Очень высокая | Ограниченная |
| Производительность | Высокая | Средняя |
| Использование | Универсальные системы | Embedded |

---

## 6. NAPI (New API)

### 6.1 Проблема прерываний

Классическая схема приёма пакетов:
- сетевое устройство генерирует прерывание на каждый пакет;
- при высокой нагрузке происходит interrupt storm.

Это снижает производительность.

---

### 6.2 Идея NAPI

**NAPI** — механизм Linux, сочетающий:
- прерывания;
- опрос (polling).

Принцип:
- при первом пакете используется прерывание;
- далее ядро опрашивает устройство, пока есть пакеты.

---

### 6.3 Работа NAPI

1. Приход первого пакета → прерывание.
2. Отключение прерываний от устройства.
3. Регистрация poll-функции.
4. Пакеты обрабатываются пачками.
5. После опустошения очереди прерывания включаются снова.

---

### 6.4 Преимущества NAPI

- Снижение нагрузки от прерываний.
- Улучшение пропускной способности.
- Предсказуемое поведение под нагрузкой.
- Эффективная работа на высоких скоростях.

---

## 7. Итог

- Сетевой стек ядра основан на абстракциях интерфейсов, пакетов и очередей.
- **sk_buff** — универсальная структура Linux для сетевых пакетов.
- **pbuf** — лёгкая альтернатива для встраиваемых систем.
- **NAPI** — ключевой механизм повышения производительности сетевого ввода в Linux.

Эти компоненты являются фундаментом современных сетевых подсистем ОС.
