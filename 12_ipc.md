# IPC

Межпроцессное взаимодействие, или Inter-Process Communication, объединяет механизмы, которые позволяют отдельным процессам обмениваться данными, сигналами и событиями, синхронизировать доступ к ресурсам и координировать выполнение. В переносимой системе базовым примитивом служит канал, представляющий собой односторонний поток байтов, соединяющий вывод одного процесса со вводом другого. Канал создается родителем, затем наследуется дочерними процессами и часто используется в конвейерах оболочки для потоковой обработки текста. Простейший пример передачи через канал показывает, как стандартный вывод первой команды становится стандартным вводом второй, сохраняя порядок байтов:

```
printf 'hello\n' | sed 's/h/H/'
```

Если требуется, чтобы процессы, не связанные родством, обменивались данными, используют именованный канал, который отображается в файловой системе и может быть открыт позднее. Создание и использование такого канала выглядит так:

```
mkfifo /tmp/demo_fifo
cat /tmp/demo_fifo &
echo 'payload' > /tmp/demo_fifo
```

Именованные каналы наследуют семантику обычных каналов: они буферизуют байты и могут блокировать записи, если нет читателя. Для двусторонней связи применяют сокеты домена Unix, которые обеспечивают надежную передачу байтов, поддержку потокового и датаграммного режимов, адресацию по пути и, что важно, возможность передачи файловых дескрипторов между процессами, позволяя делиться открытыми файлами и сокетами без раскрытия путей. Быструю проверку соединения можно выполнить универсальной утилитой:

```
socat - UNIX-LISTEN:/tmp/demo_socket,unlink-close &
nc -U /tmp/demo_socket
```

Высокоуровневые механизмы включают очереди сообщений, разделяемую память, семафоры и взаимные исключения. Очереди сообщений предоставляют дискретные сообщения с приоритетами и позволяют неблокирующее чтение, что удобно для сценариев с асинхронной обработкой. Разделяемая память дает процессам общий участок адресного пространства, обеспечивая максимальную производительность, но требует собственной синхронизации для предотвращения гонок. Семафоры и взаимные исключения регулируют доступ к разделяемым данным, не допуская одновременной записи. Системные ресурсы межпроцессного взаимодействия можно инвентаризировать и создавать для тестов командами:

```
ipcs -a
ipcmk -M 1m
```

С точки зрения практики, выбор механизма зависит от требований к упорядочиванию, задержкам и изоляции. Каналы просты и идеально подходят для линейной потоковой обработки, сокеты универсальны и позволяют строить клиент-серверные архитектуры, а разделяемая память обеспечивает минимальную задержку при высокой нагрузке на процессор. Когда нужно обменяться короткими уведомлениями, применяют сигналы: они не несут полезной нагрузки, но позволяют прерывать или завершать процессы и могут быть поставлены в очередь, если процесс установил соответствующие маски.

Передача дескрипторов через локальные сокеты — мощный прием: один процесс открывает файл или сетевое соединение и отправляет дескриптор другому, который сразу может читать или писать, даже если не имеет прав на открытие пути. Результат такой передачи можно увидеть, исследуя дескрипторы процесса, чтобы убедиться, что новый дескриптор появился:

```
ls -l /proc/$(pidof nc)/fd
```

Важная часть взаимодействия — синхронизация: при работе с разделяемой памятью часто используют семафоры или блокировки на основе файловых дескрипторов, чтобы гарантировать целостность данных. Пример блокировки файла через утилиту демонстрирует координацию доступа без явных протоколов:

```
flock /tmp/lockfile -c 'echo critical >> /tmp/log'
```

Современные системы добавляют пространства имен и контрольные группы, которые изолируют объекты межпроцессного взаимодействия между контейнерами, предотвращая случайное пересечение данных. Однако в рамках одного пространства имен ресурсы видны всем процессам с достаточными правами, поэтому управление правами и уборка ресурсов критичны: сегменты разделяемой памяти или очереди сообщений, оставленные после аварии, могут исчерпать лимиты ядра. Для удаления ненужных ресурсов используют команды, освобождающие сегменты и семафоры:

```
ipcrm -M <key>
ipcrm -S <semid>
```

При проектировании сложных систем важно учитывать семантику блокировок: каналы и сокеты обеспечивают упорядоченную доставку байтов, но не дают гарантий о границах сообщений в потоковом режиме; очереди сообщений предоставляют четкие границы, но накладывают накладные расходы; разделяемая память требует явной синхронизации, но дает наименьшие задержки. С точки зрения безопасности, передача дескрипторов и разделяемых сегментов должна контролироваться правами и проверкой источников, чтобы предотвратить подмену данных или эскалацию привилегий.

Итог: механизмы межпроцессного взаимодействия образуют набор взаимодополняющих инструментов, из которых архитектор выбирает подходящий по требованиям производительности, изоляции и надежности, комбинируя их с правильными протоколами синхронизации и стратегиями очистки ресурсов, чтобы система оставалась устойчивой и предсказуемой под нагрузкой.
