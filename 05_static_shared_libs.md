# Статически разделяемые библиотеки

Статически разделяемая библиотека в операционных системах семейства Unix описывает способ собрать набор объектных файлов в единый архив, который компоновщик целиком или частично встраивает в исполняемый файл, устраняя зависимость от внешних копий библиотек при запуске. Библиотека имеет формат архива, получаемого утилитой archiver, традиционно называемой ar, и содержит объектные файлы в формате Executable and Linkable Format с таблицами символов и секциями кода и данных. Ключевая мотивация статической компоновки — предсказуемость и автономность: бинарник работает без наличия нужных версий библиотек в системе, что важно для минимальных образов контейнеров, аварийных окружений или раннего пространства загрузки, где динамический загрузчик может отсутствовать. При этом статическая сборка увеличивает размер исполняемого файла, дублирует общий код в памяти у каждого процесса и усложняет обновление безопасности, так как исправление уязвимости в библиотеке требует пересборки всех зависимых программ.

Чтобы сформировать статическую библиотеку, исходные тексты переводятся в объектные файлы без финальной линковки; компилятор может включать оптимизации и, если нужна совместимость с позиционно независимым кодом, применять флаг Position Independent Code. Дальше объектные файлы упаковываются в архив с индексом символов, чтобы компоновщик быстро находил нужные определения.

Минимальный цикл выглядит так:

```
cc -O2 -c add.c mul.c util.c
ar rcs libmath.a add.o mul.o util.o
nm libmath.a
objdump -d libmath.a
```

Когда исполняемый файл собирается со статической библиотекой, линкер проходит аргументы слева направо и подтягивает только те объектные модули, которые удовлетворяют еще неразрешенным ссылкам, поэтому правильный порядок указания библиотек критичен. Пример корректной сборки, где библиотека идет после объектного файла, выглядит так:

```
cc main.o -L. -lmath -static -o calc_static
```

Этот флаг полной статической линковки заставляет включить даже стандартную библиотеку языка C, что обеспечивает работу без внешних динамических зависимостей, но требует совместимости с системными вызовами ядра, так как интерфейсы пользовательского пространства больше не обновляются через динамические библиотеки. Для диагностики итогового файла полезно посмотреть динамический раздел, который должен быть пуст или минимален при строгой статике, а также убедиться, что зависимости к динамическим библиотекам отсутствуют:

```
readelf -d calc_static
ldd calc_static
```

Статические библиотеки применяются, когда нужно исключить влияние окружения на работу программы, например в закрытых аплайнсах, на встраиваемых устройствах без пакетного менеджера или в безопасных конвейерах, где запрещено подгружать внешние компоненты. Однако они порождают риски устаревших зависимостей: если библиотека криптографии или стандартная библиотека содержат уязвимость, каждый собранный бинарник остается уязвимым до пересборки. В корпоративной среде это решается автоматическими пайплайнами, пересобирающими все приложения при обновлении базовых библиотек, но цена такого подхода — время и ресурсы.

С точки зрения производительности статическая компоновка уменьшает накладные расходы на динамический загрузчик и потенциально упрощает прогнозирование расположения символов, но лишает процессов возможности разделять страницы кода, увеличивая суммарный расход памяти на узле. Важно понимать, что статическая библиотека — лишь архив объектных файлов; в отличие от динамической, она не содержит раздела с версиями символов и не может подхватываться во время выполнения. Разработчику следует документировать совместимые версии компилятора и опций, потому что статический код фиксирует соглашения о вызовах и структуре стандартной библиотеки.

При подготовке аварийных initramfs или минимального userspace нередко создают статические версии ключевых утилит, например оболочки BusyBox, чтобы обеспечить работоспособность без зависимости от каталога /lib. Проверить размер и состав архива помогает команда инвентаризации, а удаление устаревших объектных файлов выполняется пересборкой архива без лишних модулей:

```
ar t libmath.a
```

В результате статическая разделяемая библиотека остаётся инструментом для контроля среды исполнения: она повышает автономность и предсказуемость ценой большего объема и необходимости дисциплины при обновлениях, и именно этот баланс должен оценивать архитектор или технический директор, когда выбирает стратегию поставки программного обеспечения.
