
# Системный журнал. Syslog. Journald

## 1. Зачем нужен системный журнал

Системный журнал (system log) — это подсистема ОС, которая:
- собирает **сообщения о событиях** от ядра, системных служб и приложений;
- сохраняет их в **журналы** (лог-файлы или базы данных);
- предоставляет **интерфейс для просмотра, фильтрации и анализа** этих сообщений;
- позволяет настроить **реакцию на события** (уведомления, отправка по сети, ротация логов и т. п.).

Цели:
- диагностика и отладка;
- аудит безопасности;
- мониторинг состояния системы;
- расследование инцидентов.

В Linux традиционно использовался **syslog** (такие демоны, как `syslogd`, `rsyslog`, `syslog-ng`).  
В системах на базе `systemd` дополнительно появился **journald**.

---

## 2. Классический Syslog

### 2.1. Общая идея

**Syslog** — стандартный механизм логирования в UNIX-подобных ОС.

Состоит из:
- **клиентов** (программы, ядро, демоны), которые посылают сообщения;
- **демона syslog** (`syslogd`, `rsyslogd`, `syslog-ng`), который:
  - принимает сообщения,
  - классифицирует их,
  - в соответствии с конфигурацией записывает в файлы, пересылает по сети, фильтрует и т. п.

Передача локальных сообщений обычно идёт через:
- Unix domain socket (например, `/dev/log`),
- или через системный вызов `syslog`/функции библиотеки `syslog()`.

Удалённые сообщения могут передаваться по сети (UDP/TCP, порт 514 по умолчанию).

---

### 2.2. Структура сообщения syslog

Классическое сообщение содержит:
- **priority (pri)** — комбинированное поле: facility + severity;
- **метку времени (timestamp)**;
- **имя хоста (hostname)**;
- **имя программы/процесса** (tag);
- сам **текст сообщения**.

#### Facility (источник/подсистема)

Обозначает, откуда пришло сообщение:

- `kern` — ядро;
- `user` — пользовательские процессы;
- `mail` — почтовая подсистема;
- `daemon` — системные демоны;
- `auth`, `authpriv` — аутентификация/безопасность;
- `syslog` — сам демон syslog;
- `lpr` — печать;
- `cron` — планировщик заданий;
- `local0`–`local7` — локально определяемые.

#### Severity (уровень важности)

уровни (от более критичных к менее):

- `emerg` (0) — система неработоспособна;
- `alert` (1) — срочные действия;
- `crit` (2) — критические состояния;
- `err` (3) — ошибки;
- `warning` (4) — предупреждения;
- `notice` (5) — важные, но не ошибка;
- `info` (6) — информационные;
- `debug` (7) — отладочные сообщения.

---

### 2.3. Демоны syslog: syslogd, rsyslog, syslog-ng

В разных системах может использоваться:
- классический `syslogd`;
- **rsyslog** — более функциональный (поддержка модулей, ротации, фильтров, TCP/UDP, TLS и т. д.);
- **syslog-ng** — альтернативный расширенный демон.

Они реализуют примерно ту же модель, но с разными возможностями.

---

### 2.4. Конфигурация syslog (общая идея)

Конфигурация задаёт, какие сообщения куда направлять.

Типичный формат правила (на примере rsyslog/syslogd):

```text
facility.level   destination
```

Примеры:
- `authpriv.*           /var/log/auth.log`  
- `mail.info           /var/log/mail.log`  
- `*.emerg             *` (рассылка всем вошедшим пользователям)

**destination**:
- файл (`/var/log/...`);
- консоль (`/dev/console`);
- удалённый хост (`@logserver.example.com`);
- named pipe, программа и т. д.

---

### 2.5. Файлы логов в классической схеме

Обычно (примерно, может отличаться):
- `/var/log/syslog` или `/var/log/messages` — общесистемные сообщения;
- `/var/log/auth.log` — авторизация/безопасность;
- `/var/log/kern.log` — сообщения ядра;
- `/var/log/mail.log` — почтовая подсистема;
- `/var/log/daemon.log` — демоны и службы;
- и многие другие специализированные логи.

Ротация (ограничение размера, архивирование, удаление старых логов) обычно регулируется `logrotate` или встроенными средствами демона.

---

## 3. Journald (systemd-journald)

### 3.1. Общая характеристика

**systemd-journald** — служба журналирования, входящая в состав `systemd`.  
Она:

- собирает лог-сообщения от:
  - ядра (через `kmsg`),
  - демонов systemd (stdout/stderr сервисов),
  - классического syslog (через сокет `/run/systemd/journal/syslog`),
  - логов аудита и других источников;
- сохраняет сообщения в **бинарном формате** (журнал systemd);
- предоставляет интерфейс чтения логов через `journalctl` и API (libsystemd).

Важно: journald не обязательно полностью заменяет syslog — часто они **работают вместе**.

---

### 3.2. Отличия от классического syslog

Главные отличия journald:

1. **Структурированные записи**
   - Каждое сообщение — набор полей «ключ=значение»:  
     `MESSAGE=...`, `PRIORITY=...`, `SYSLOG_IDENTIFIER=...`, `UID=...`, `PID=...`, `UNIT=...` и т. д.
   - Можно легко фильтровать по полям (например, по юниту `systemd`).

2. **Бинарный формат хранения**
   - Логи хранятся не как текстовые файлы, а в собственном бинарном журнале:
     - /run/log/journal (в памяти, исчезает при перезагрузке),
     - /var/log/journal (постоянное хранение, если включено).
   - Журнал содержит метаданные, индексы, контрольные суммы.

3. **Интеграция с systemd**
   - Каждому сервису (unit-файлу) соответствует **идентификатор юнита**.
   - Все сообщения, выводимые процессом через stdout/stderr, автоматически попадают в журнал и связываются с конкретным юнитом.

4. **Дополнительная мета-информация**
   - journald автоматически добавляет:
     - UID, GID, SELinux-контекст, cgroup, контейнер, идентификатор бут-процесса и т. д.
   - Это облегчает анализ и фильтрацию.

---

### 3.3. Хранение журналов journald

Типичные пути:
- `/run/log/journal/` — volatile (в ОЗУ, очищается при перезагрузке);
- `/var/log/journal/` — persistent (сохраняется между перезагрузками, если каталог создан и разрешён).

Журнал разделяется на файлы с ограничением по размеру, реализуется автоматическая ротация, контроль использования места на диске.

---

### 3.4. Уровни приоритета в journald

Приоритет (`PRIORITY=`) соответствует известным уровням (как в syslog):

- `0` — `emerg`,
- `1` — `alert`,
- `2` — `crit`,
- `3` — `err`,
- `4` — `warning`,
- `5` — `notice`,
- `6` — `info`,
- `7` — `debug`.

При выводе можно фильтровать по приоритетам.

---

### 3.5. Просмотр логов через journalctl

Основной инструмент пользователя — команда `journalctl`.

Примеры:

- показать все сообщения:
  ```bash
  journalctl
  ```

- только текущую загрузку:
  ```bash
  journalctl -b
  ```

- сообщения от конкретного юнита:
  ```bash
  journalctl -u ssh.service
  ```

- последние строки и «follow» (аналог `tail -f`):
  ```bash
  journalctl -f
  ```

- фильтрация по приоритету:
  ```bash
  journalctl -p err
  ```

- по времени:
  ```bash
  journalctl --since "2025-01-01" --until "2025-01-02"
  ```

Вывод по умолчанию форматируется красиво (с цветами, полями). Можно запросить вывод в JSON, экспорт в текст и т. п.

---

### 3.6. Взаимодействие journald и syslog

Journald и syslog могут работать **совместно**, примерно так:

- службы systemd и ядро пишут в journald;
- journald по нужным настройкам:
  - сам хранит журнал,
  - **форвардит** сообщения в традиционный syslog-демон (rsyslog),
  - откуда они уже:
    - пишутся в /var/log/*.log,
    - отправляются на удалённые сервера и т. д.

Таким образом:
- journald выступает как центральный сборщик логов в системе systemd;
- syslog — как совместимый с традиционными системами механизм и транспорт/архиватор.

---

## 4. Практическое сравнение: Syslog vs Journald

| Характеристика         | Syslog                           | Journald                                      |
|------------------------|----------------------------------|-----------------------------------------------|
| Формат хранения        | Текстовые файлы                 | Бинарный журнал                               |
| Структура сообщений    | Строка, pri (facility+severity) | Набор полей ключ=значение                     |
| Метаданные             | Ограничены                      | Богатый набор (PID, UID, cgroup, UNIT, boot…) |
| Фильтрация             | По facility/priority, regexp    | По полям (unit, UID, PRIORITY, время…)        |
| Инструмент просмотра   | `less`, `tail`, утилиты syslog  | `journalctl`                                  |
| Сетевой логгинг        | Натурально поддерживается       | Обычно через форвардинг в syslog              |
| Совместимость          | Исторический стандарт           | Специфично для systemd                        |

---

## 5. Резюме

- **Системный журнал** — ключевой механизм ОС для записи и анализа событий.
- **Syslog**:
  - классический текстовый механизм логирования;
  - разделение по facility/priority;
  - хранение в `/var/log/*.log`;
  - возможность отправки по сети на удалённые лог-серверы.
- **Journald** (systemd-journald):
  - современный бинарный журнал, тесно интегрированный с systemd;
  - структурированные записи с большим количеством метаданных;
  - удобный просмотр и фильтрация через `journalctl`;
  - может работать совместно с syslog, выступая центральным сборщиком и источником для традиционных лог-файлов.

Понимание работы syslog и journald важно для:
- администрирования UNIX/Linux-систем;
- диагностики проблем;
- настройки безопасного и надёжного логирования в операционных системах.